!function(t){var s={};function e(i){if(s[i])return s[i].exports;var r=s[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,e),r.l=!0,r.exports}e.m=t,e.c=s,e.d=function(t,s,i){e.o(t,s)||Object.defineProperty(t,s,{configurable:!1,enumerable:!0,get:i})},e.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},e.n=function(t){var s=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(s,"a",s),s},e.o=function(t,s){return Object.prototype.hasOwnProperty.call(t,s)},e.p="",e(e.s=0)}([function(t,s,e){"use strict";e.r(s);function i(t,s){return{x:t.x*s.a+t.y*s.c+s.e,y:t.x*s.b+t.y*s.d+s.f}}class r{constructor(){this._mouseX=0,this._mouseY=0,this.subscribers={},this.wheel=(t=>{this.getMousePosition(t);for(const s of this.subscribers.wheel)s(t)}),this.mousemove=(t=>{this.getMousePosition(t)})}get mouse(){const t=(s={x:this._mouseX,y:this._mouseY},e=this.ctx.getTransform().inverse(),{x:s.x*e.a+s.y*e.c+e.e,y:s.x*e.b+s.y*e.d+e.f});var s,e;return t.clientX=this._mouseX,t.clientY=this._mouseY,t}init(t,s){t.addEventListener("mousemove",this.mousemove),t.addEventListener("wheel",this.wheel),this.ctx=s}subscribe(t,s){this.subscribers[t]||(this.subscribers[t]=new Array),this.subscribers[t].push(s)}getMousePosition(t){const s=this.ctx.canvas.getBoundingClientRect();this._mouseX=t.clientX-s.left,this._mouseY=t.clientY-s.top}static get Instance(){return this._instance||(this._instance=new this)}}class n{constructor(t,s){this.x=t,this.y=s}clone(){return Object.assign(Object.create(Object.getPrototypeOf(this)),this)}equals(t){return t.x===this.x&&t.y===this.y&&t.rot===this.rot}}class o{constructor(t,s){this.transform=new n(t,s),this.lastTransform=this.transform.clone()}update(){}render(t,s){}setLastTransform(){this.lastTransform=this.transform.clone()}getInterpolatedTransform(t){const s=this.lastTransform.x+t*(this.transform.x-this.lastTransform.x),e=this.lastTransform.y+t*(this.transform.y-this.lastTransform.y);return new n(s,e)}}const a=1.15;class h extends o{constructor(){super(0,0),this.zoom=1,this.inputController=r.Instance,this.inputController.subscribe("wheel",t=>{this.zoomToPoint(this.zoom*(t.deltaY>0?1/a:a),this.inputController.mouse.clientX,this.inputController.mouse.clientY)})}zoomToPoint(t,s,e){let i=l();const r=c({x:s,y:e},(i=i.scaleNonUniform(this.zoom,this.zoom).translate(this.transform.x,this.transform.y)).inverse()),n=c({x:s,y:e},(i=(i=l()).scaleNonUniform(t,t).translate(this.transform.x,this.transform.y)).inverse());this.transform.x-=n.x-r.x,this.transform.y-=n.y-r.y,this.zoom=t}shake(){}render(t){t.resetTransform(),t.scale(this.zoom,this.zoom),t.translate(-this.transform.x,-this.transform.y)}}function c(t,s){return{x:t.x*s.a+t.y*s.c+s.e,y:t.x*s.b+t.y*s.d+s.f}}const l=function(){return document.createElementNS("http://www.w3.org/2000/svg","g").getCTM()};class u{constructor(){this.entities=[]}update(){this.entities.forEach(t=>{t.setLastTransform(),t.update()})}render(t,s){this.entities.forEach(e=>{e.render(t,e.getInterpolatedTransform(s))})}addEntity(t){this.entities.push(t)}}class m extends o{constructor(){super(...arguments),this.frameCount=0,this.inputController=r.Instance}update(){this.frameCount++,this.transform.x=150+100*Math.cos(this.frameCount/5),this.transform.y=150+100*Math.sin(this.frameCount/5)}render(t,s){t.fillStyle="#ff0000",t.fillRect(s.x,s.y,50,50)}}class f extends o{constructor(t,s){super(t,s),this.frameCount=0,this.inputController=r.Instance,this.imgloaded=!1,this.img=new Image,this.img.onload=(()=>{console.log("loaded"),this.imgloaded=!0}),this.img.src="tilesets/tileset1.png"}update(){this.frameCount++,this.transform.x=this.inputController.mouse.x,this.transform.y=this.inputController.mouse.y}render(t,s){t.fillStyle="#ff0000",this.imgloaded?t.drawImage(this.img,s.x,s.y):t.fillRect(s.x,s.y,50,50)}}const d=new class{constructor(){this.entityManager=new u,this.camera=new h,this.entityManager.addEntity(new m(100,100)),this.entityManager.addEntity(new f(100,100))}update(t){this.entityManager.update()}render(t,s){this.camera.render(t),this.entityManager.render(t,s)}};let x,p,y;const g=r.Instance;window.onload=function(){p=document.getElementById("canvas"),y=w(p.getContext("2d")),p.width=720,p.height=480,g.init(p,y),(x=new class{constructor(t){this.ctx=t,this.worlds=[]}init(){this.lastTick=performance.now(),this.lastRender=this.lastTick,this.tickLength=50,this.maxTicks=20,this.main(performance.now())}addWorld(t){this.worlds.push(t)}render(t){const s=(t-this.lastTick)/this.tickLength;this.ctx.save(),this.ctx.fillStyle="#ffffff";const e=this.ctx.getTransform().inverse(),r=i({x:0,y:0},e),n=i({x:this.ctx.canvas.width,y:this.ctx.canvas.height},e);this.ctx.fillRect(r.x,r.y,n.x-r.x,n.y-r.y),this.ctx.restore(),this.worlds.forEach(t=>{t.render(this.ctx,s)}),this.ctx.save(),this.fps=(1e3/(t-this.lastRender)).toPrecision(5),this.ctx.font="20px sans-serif",this.ctx.fillStyle="#eaeaea",this.ctx.fillText(this.fps+" fps",20,20),this.ctx.restore()}update(t){this.worlds.forEach(s=>{s.update(t)})}main(t){this.stopMain=window.requestAnimationFrame(t=>this.main(t));let s=0;if(t>this.lastTick+this.tickLength){const e=t-this.lastTick;s=Math.floor(e/this.tickLength)}this.queueUpdates(s),this.render(t),this.lastRender=t}queueUpdates(t){if(t>this.maxTicks)return console.log("System couldn't keep up -- skipping "+t+" ticks"),void(this.lastTick=this.lastTick+this.tickLength*t);for(let s=0;s<t;s++)this.lastTick=this.lastTick+this.tickLength,this.update(this.lastTick)}}(y)).addWorld(d),window.game=x,x.init()};const _=function(){return document.createElementNS("http://www.w3.org/2000/svg","g").getCTM()},w=function(t){const s=_();t._matrix=s,t._savedMatrices=[s];const e=t.__proto__;return t.__proto__={_setMatrix(){const t=this._matrix;e.setTransform.call(this,t.a,t.b,t.c,t.d,t.e,t.f)},save(){this._savedMatrices.push(this._matrix),e.save.call(this)},restore(){0!==this._savedMatrices.length&&(e.restore.call(this),this._matrix=this._savedMatrices.pop(),this._setMatrix())},scale(t,s){this._matrix=this._matrix.scaleNonUniform(t,s),e.scale.call(this,t,s)},getTransform(){return this._matrix},rotate(t){this._matrix=this._matrix.rotate(180*t/Math.PI),e.rotate.call(this,t)},translate(t,s){this._matrix=this._matrix.translate(t,s),e.translate.call(this,t,s)},transform(t,s,i,r,n,o){const a=_();a.a=t,a.b=s,a.c=i,a.d=r,a.e=n,a.f=o,this._matrix=this._matrix.multiply(a),e.transform.call(this,t,s,i,r,n,o)},resetTransform(){this._matrix=_(),e.resetTransform.call(this)},__proto__:e},t}}]);