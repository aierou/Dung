!function(t){var s={};function i(e){if(s[e])return s[e].exports;var r=s[e]={i:e,l:!1,exports:{}};return t[e].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=s,i.d=function(t,s,e){i.o(t,s)||Object.defineProperty(t,s,{configurable:!1,enumerable:!0,get:e})},i.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},i.n=function(t){var s=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(s,"a",s),s},i.o=function(t,s){return Object.prototype.hasOwnProperty.call(t,s)},i.p="",i(i.s=0)}([function(t,s,i){"use strict";i.r(s);class e{constructor(t,s){this.x=t,this.y=s}toString(){return this.x+", "+this.y}}class r{get position(){return new e(this.x,this.y)}constructor(t,s){this.x=t,this.y=s}clone(){return Object.assign(Object.create(Object.getPrototypeOf(this)),this)}equals(t){return t.x===this.x&&t.y===this.y&&t.rot===this.rot}}class n{constructor(){this._dragging=!1}get dragging(){return this._dragging}get dragPosition(){return this._dragPosition}get objectPosition(){return this._objectPosition}startDrag(t,s,i){this._objectPosition=t,this._dragPosition=new r(s,i),this._dragging=!0}stopDrag(){this._dragging=!1}}class h{get bottom(){return this.y+this.height}get right(){return this.x+this.width}constructor(t,s,i,e){this.x=t,this.y=s,this.width=i,this.height=e}contains(t){return t.x>=this.x&&t.y>=this.y&&t.x+t.width<this.right&&t.y+t.height<this.bottom}containsPoint(t){return t.x>=this.x&&t.y>=this.y&&t.x<this.right&&t.y<this.bottom}intersects(t){return t.right>this.x&&t.bottom>this.y&&this.right>t.x&&this.bottom>t.y}expand(t){return this.x-=t,this.y-=t,this.width+=2*t,this.height+=2*t,this}translate(t,s){return this.x+=t,this.y+=s,this}scaleToGrid(t){return this.x=Math.floor(this.x/t),this.y=Math.floor(this.y/t),this.width=Math.floor(this.width/t),this.height=Math.floor(this.height/t),this}*iterateGrid(t=1){const s=Math.floor(this.right/t),i=Math.floor(this.bottom/t);for(let r=Math.floor(this.x/t);r<s;r++)for(let s=Math.floor(this.y/t);s<i;s++)yield new e(r,s)}}class o{constructor(){this._mouseX=0,this._mouseY=0,this._mouseDown=!1,this._keys={},this.subscribers={},this.wheel=(t=>{this.getMousePosition(t);for(const s of this.subscribers.wheel)s(t)}),this.keydown=(t=>{this._keys[t.key]=!0}),this.keyup=(t=>{this._keys[t.key]=!1}),this.mousedown=(t=>{this._mouseDown=!0}),this.mouseup=(t=>{this._mouseDown=!1}),this.mousemove=(t=>{this.getMousePosition(t);for(const s of this.subscribers.mousemove)s(t)})}get mouse(){const t=(s={x:this._mouseX,y:this._mouseY},i=this.ctx.getTransform().inverse(),{x:s.x*i.a+s.y*i.c+i.e,y:s.x*i.b+s.y*i.d+i.f});var s,i;return t.clientX=this._mouseX,t.clientY=this._mouseY,t.isDown=this._mouseDown,t}getKey(t){return!!this._keys[t]}init(t,s){t.addEventListener("mousemove",this.mousemove),t.addEventListener("wheel",this.wheel),t.addEventListener("mousedown",this.mousedown),t.addEventListener("mouseup",this.mouseup),document.addEventListener("keydown",this.keydown),document.addEventListener("keyup",this.keyup),this.ctx=s}subscribe(t,s){this.subscribers[t]||(this.subscribers[t]=new Array),this.subscribers[t].push(s)}getMousePosition(t){const s=this.ctx.canvas.getBoundingClientRect();this._mouseX=t.clientX-s.left,this._mouseY=t.clientY-s.top}static get Instance(){return this._instance||(this._instance=new this)}}const a=1.15;class l{constructor(){this.zoom=.5,this.inputController=o.Instance,this.dragInfo=new n,this.MINIMUM_SCALE=.1,this.MAXIMUM_SCALE=20,this.transform=new r(0,0),this.inputController.subscribe("wheel",t=>{this.inputController.getKey("Control")&&(this.zoomToPoint(this.zoom*(t.deltaY>0?1/a:a),this.inputController.mouse.clientX,this.inputController.mouse.clientY),t.preventDefault())}),this.inputController.subscribe("mousemove",t=>{if(this.dragInfo.dragging&&this.inputController.getKey("Control")){const t=this.inputController.mouse;let s=u();s=s.scaleNonUniform(this.zoom,this.zoom).translate(this.transform.x,this.transform.y);const i={x:this.dragInfo.dragPosition.x-t.x,y:this.dragInfo.dragPosition.y-t.y};this.transform.x=this.dragInfo.objectPosition.x+i.x,this.transform.y=this.dragInfo.objectPosition.y+i.y}})}resize(t,s){this.width=t,this.height=s}getScale(){return this.zoom}getBoundingRectangle(){return new h(this.transform.x,this.transform.y,this.width,this.height)}zoomToPoint(t,s,i){t=Math.min(Math.max(t,this.MINIMUM_SCALE),this.MAXIMUM_SCALE);let e=u();const r=c({x:s,y:i},(e=e.scaleNonUniform(this.zoom,this.zoom).translate(this.transform.x,this.transform.y)).inverse()),n=c({x:s,y:i},(e=(e=u()).scaleNonUniform(t,t).translate(this.transform.x,this.transform.y)).inverse());this.transform.x-=n.x-r.x,this.transform.y-=n.y-r.y,this.zoom=t}performDrag(){const t=this.inputController.mouse;t.isDown&&this.inputController.getKey("Control")?this.dragInfo.dragging||this.dragInfo.startDrag(this.transform,t.x,t.y):this.dragInfo.dragging&&this.dragInfo.stopDrag()}shake(){}render(t){t.resetTransform(),t.scale(this.zoom,this.zoom),t._scale=this.zoom,t.translate(-this.transform.x,-this.transform.y),this.performDrag()}}function c(t,s){return{x:t.x*s.a+t.y*s.c+s.e,y:t.x*s.b+t.y*s.d+s.f}}const u=function(){return document.createElementNS("http://www.w3.org/2000/svg","g").getCTM()};class d{constructor(t=0,s=0){this.transform=new r(t,s)}render(t){}}class f extends d{constructor(t,s){super(t,s)}render(t){}}class g extends f{constructor(t,s="bold 20px sans-serif",i="#ffffff"){super(20,20),this.font=s,this.color=i,this.text=t}render(t){t.save(),t.font=this.font,t.fillStyle=this.color,t.fillText(this.text,this.transform.x,this.transform.y),this.outline&&(t.strokeStyle="#000000",t.strokeText(this.text,this.transform.x,this.transform.y)),t.restore()}}class m{constructor(){this.elements=new Array}addUIElement(t){this.elements.push(t)}render(t){t.save(),t.resetTransform(),this.elements.forEach(s=>{s.render(t)}),t.restore()}}function p(t,s){return{x:t.x*s.a+t.y*s.c+s.e,y:t.x*s.b+t.y*s.d+s.f}}class x extends d{get width(){return this.image.width}get height(){return this.image.height}constructor(t){super(),this.image=t}render(t,s=this.width,i=this.height){t.drawImage(this.image,this.transform.x,this.transform.y,s,i)}}class y{constructor(t,s,i){this.sprites=new Array,this.spritesheetFileName=t,this.spriteWidth=s,this.spriteHeight=i}load(){return new Promise((t,s)=>{this.spritesheet=new Image,this.spritesheet.onload=(()=>t(this.createSprites())),this.spritesheet.src=this.spritesheetFileName})}getSprite(t){return new x(this.sprites[t])}createSprites(){const t=this.spritesheet.width/this.spriteWidth,s=this.spritesheet.height/this.spriteHeight,i=new Array;for(let e=0;e<t;e++)for(let t=0;t<s;t++)i.push(new Promise((i,r)=>{createImageBitmap(this.spritesheet,e*this.spriteWidth,t*this.spriteHeight,this.spriteWidth,this.spriteHeight).then(r=>{const n=t*s+e;this.sprites[n]=r,i()})}));return Promise.all(i)}}class w{get x(){return this._x}get y(){return this._y}get id(){return this._id}set id(t){this._id=t}get sprite(){return this._sprite}constructor(t,s,i){this._id=t,this._x=s,this._y=i}applySprite(t,s){this._sprite=t.getSprite(this._id),this._sprite.transform=s}}class k{constructor(t,s,i){this.tiles=new Array,this.tileset=t,this.spritesheet=new y("tilesets/"+t+".png",s,s),this.tileCanvas=document.createElement("canvas"),this.tileCanvas.width=i*s,this.tileCanvas.height=i*s,this.chunkSize=i,this.tileSize=s,this.scaledTileSize=s,this.tileCanvasCtx=this.tileCanvas.getContext("2d"),this.load().then(()=>{for(let t=0;t<i;t++)for(let s=0;s<i;s++){const i=new w(1,t,s);i.applySprite(this.spritesheet,new r(t*this.scaledTileSize,s*this.scaledTileSize)),this.tiles.push(i)}this.tiles.forEach(t=>{t.sprite.render(this.tileCanvasCtx,this.scaledTileSize,this.scaledTileSize)})})}setTile(t,s,i){if(s<this.chunkSize&&i<this.chunkSize){let e=this.tiles.find(t=>t.x===s&&t.y===i);e||(e=new w(t,s,i),this.tiles.push(e)),e.id!==t&&(e.id=t,e.applySprite(this.spritesheet,new r(s*this.scaledTileSize,i*this.scaledTileSize)),e.sprite.render(this.tileCanvasCtx,this.scaledTileSize,this.scaledTileSize))}}getTile(t,s){return this.tiles.find(i=>i.x===t&&i.y===s)}isEmpty(){return 0===this.tiles.length}load(){return this.spritesheet.load()}resizeImage(t){this.scaledTileSize=t,this.tileCanvas.width=this.chunkSize*t,this.tileCanvas.height=this.chunkSize*t,this.tileCanvasCtx.fillRect(0,0,this.chunkSize*t,this.chunkSize*t),this.tiles.forEach(s=>{s.sprite.transform.x=s.x*t,s.sprite.transform.y=s.y*t,s.sprite.render(this.tileCanvasCtx,t,t)})}render(t,s,i){const e=this.chunkSize*this.tileSize,r=performance.now();t.drawImage(this.tileCanvas,s,i,e,e);const n=performance.now()-r;n>100&&(console.log("tile render took "+n+" ms"),console.log(s+" "+i+" "+e),console.log(this))}}class _{get width(){return this.chunkSize*this.tileSize}get height(){return this.chunkSize*this.tileSize}get tiles(){return this.tileManager}get position(){return this.transform.position}constructor(t,s,i,e){this.transform=new r(t,s),this.entities=new Array,this.tileManager=new k("tileset1",i,e),this.chunkSize=e,this.tileSize=i,this.scaledTileSize=i}getEntities(){return this.entities}isEmpty(){return 0===this.entities.length&&this.tileManager.isEmpty()}saveEntities(t){this.entities=t}getTilePosition(t,s){return{x:Math.floor((t-this.transform.x*this.width)/this.tileSize),y:Math.floor((s-this.transform.y*this.height)/this.tileSize)}}getBoundingRectangle(){return new h(this.transform.x*this.width,this.transform.y*this.height,this.width,this.height)}containsTransform(t){return t.x>=this.transform.x&&t.y>=this.transform.y&&t.x<this.transform.x+this.width&&t.y<this.transform.y+this.height}resizeImage(t){t!==this.scaledTileSize&&(this.scaledTileSize=t,this.tileManager.resizeImage(t))}render(t){this.tileManager.render(t,this.transform.x*this.width,this.transform.y*this.height)}}class S extends d{constructor(t=0,s=0){super(t,s),this.lastTransform=this.transform.clone()}update(){}render(t,s){}setLastTransform(){this.lastTransform=this.transform.clone()}getInterpolatedTransform(t){const s=this.lastTransform.x+t*(this.transform.x-this.lastTransform.x),i=this.lastTransform.y+t*(this.transform.y-this.lastTransform.y);return new r(s,i)}getBoundingRectangle(){return new h(this.transform.x,this.transform.y,this.width,this.height)}}class C extends S{constructor(){super(...arguments),this.frameCount=0,this.inputController=o.Instance}update(){this.frameCount++,this.transform.x=150+100*Math.cos(this.frameCount/5),this.transform.y=150+100*Math.sin(this.frameCount/5)}render(t,s){t.fillStyle="#ff0000",t.fillRect(s.x,s.y,50,50)}}class z extends S{constructor(t,s){super(t,s),this.frameCount=0,this.inputController=o.Instance}update(){this.frameCount++}render(t,s){this.transform.x=128*Math.floor(this.inputController.mouse.x/128),this.transform.y=128*Math.floor(this.inputController.mouse.y/128),t.fillStyle="#ff0000",t.fillRect(this.transform.x,this.transform.y,128,128)}}class M{constructor(){this.entities=[]}update(){this.entities.forEach(t=>{t.setLastTransform(),t.update()})}render(t,s){this.entities.forEach(i=>{i.render(t,i.getInterpolatedTransform(s))})}addEntity(t){this.entities.push(t)}addEntities(t){this.entities=this.entities.concat(t)}unloadAndSaveToChunk(t){const s=[];return this.entities=this.entities.filter(i=>{return!t.getBoundingRectangle().containsPoint(i.transform.position)||(s.push(i),!1)}),s}}let T,v,b,I;const E=o.Instance;window.onload=function(){b=document.getElementById("canvas"),I=L(b.getContext("2d")),window.onresize=P,E.init(b,I),v=new class{constructor(t){this.ctx=t,this.worlds=[],this.uiManager=new m,this.fpsLabel=new g(this.fps),this.fpsLabel.outline=!0,this.uiManager.addUIElement(this.fpsLabel),this.camera=new l}init(){this.lastTick=performance.now(),this.lastRender=this.lastTick,this.tickLength=50,this.maxTicks=20,this.main(performance.now())}resize(t,s){const i=p({x:t,y:s},this.ctx.getTransform().inverse());this.camera.resize(i.x,i.y)}getActiveCamera(){return this.camera}addWorld(t){this.worlds.push(t)}render(t){const s=(t-this.lastTick)/this.tickLength;this.ctx.save(),this.ctx.fillStyle="#ffffff";const i=this.ctx.getTransform().inverse(),e=p({x:0,y:0},i),r=p({x:this.ctx.canvas.width,y:this.ctx.canvas.height},i),n=new h(e.x,e.y,r.x-e.x,r.y-e.y);this.ctx.fillRect(n.x,n.y,n.width,n.height),this.ctx.restore(),this.fps=(1e3/(t-this.lastRender)).toPrecision(5),this.camera.resize(n.width,n.height),this.camera.render(this.ctx),this.worlds.forEach(t=>{t.render(this.ctx,s)}),this.fpsLabel.text=this.fps+" fps",this.uiManager.render(this.ctx)}update(t){this.worlds.forEach(s=>{s.update(t)})}main(t){this.stopMain=window.requestAnimationFrame(t=>this.main(t));let s=0;if(t>this.lastTick+this.tickLength){const i=t-this.lastTick;s=Math.floor(i/this.tickLength)}this.queueUpdates(s),this.render(t),this.lastRender=t}queueUpdates(t){if(t>this.maxTicks)return console.log("System couldn't keep up -- skipping "+t+" ticks"),void(this.lastTick=this.lastTick+this.tickLength*t);for(let s=0;s<t;s++)this.lastTick=this.lastTick+this.tickLength,this.update(this.lastTick)}}(I),T=new class{constructor(t){this.loadedChunks=new Array,this.chunkSize=16,this.tileSize=128,this.inputController=o.Instance,this.game=t,this.entityManager=new M,this.chunks=new Map;const s=new Array;s.push(new C(100,100)),s.push(new z(100,100));const i=new _(0,0,this.tileSize,this.chunkSize);i.saveEntities(s),this.chunks.set(i.position.toString(),i)}update(t){this.entityManager.update(),this.updateChunks();const s=this.inputController.mouse;if(s.isDown){const t=this.getChunkAtPosition(s.x,s.y);if(t){const i=t.getTilePosition(s.x,s.y);t.tiles.setTile(0,i.x,i.y)}}const i=Math.min(this.game.getActiveCamera().getScale()*this.tileSize,this.tileSize);for(const t of this.loadedChunks)t.resizeImage(i)}render(t,s){for(const s of this.loadedChunks)s.tiles.isEmpty()||s.render(t);for(const s of this.loadedChunks){t.fillStyle=(s.position.x+s.position.y)%2==0?"#66666666":"#88888866";const i=s.getBoundingRectangle();t.fillRect(i.x,i.y,i.width,i.height);const r=new e(i.x/(this.chunkSize*this.tileSize),i.y/(this.chunkSize*this.tileSize));t.fillStyle="#ffffffaa",t.font="bold 500px sans-serif",t.fillText(r.x+", "+r.y,i.x+i.width/3,i.y+i.height/2)}this.entityManager.render(t,s)}loadChunk(t,s=!0){s&&this.loadedChunks.find(s=>s===t)||(this.loadedChunks.push(t),this.entityManager.addEntities(t.getEntities()))}unloadChunk(t,s=!0){const i=this.loadedChunks.findIndex(s=>s===t);s&&-1===i||(t.saveEntities(this.entityManager.unloadAndSaveToChunk(t)),this.loadedChunks.splice(i,1))}getChunkAtPosition(t,s){const i=this.tileSize*this.chunkSize;return this.chunks.get(new e(Math.floor(t/i),Math.floor(s/i)).toString())}updateChunks(){const t=this.game.getActiveCamera().getBoundingRectangle().scaleToGrid(this.chunkSize*this.tileSize).expand(1).translate(1,1),s=new Array,i=t.iterateGrid();for(const t of i){let i=this.chunks.get(t.toString());i||(i=new _(t.x,t.y,this.tileSize,this.chunkSize),this.chunks.set(t.toString(),i)),s.push(i)}const e=this.loadedChunks.filter(t=>-1===s.indexOf(t)),r=s.filter(t=>-1===this.loadedChunks.indexOf(t));for(const t of e)this.unloadChunk(t,!1);e.length>0&&console.log("Unloading "+e.length+" chunks");for(const t of r)this.loadChunk(t,!1);r.length>0&&console.log("Loading "+r.length+" chunks")}}(v),v.addWorld(T),window.game=v,P(),v.init()};const P=function(){b.width=window.innerWidth,b.height=window.innerHeight,v&&v.resize(b.width,b.height)},A=function(){return document.createElementNS("http://www.w3.org/2000/svg","g").getCTM()},L=function(t){const s=A();t._matrix=s,t._scale=1,t._savedMatrices=[s];const i=t.__proto__;return t.__proto__={_setMatrix(){const t=this._matrix;i.setTransform.call(this,t.a,t.b,t.c,t.d,t.e,t.f)},save(){this._savedMatrices.push(this._matrix),i.save.call(this)},restore(){0!==this._savedMatrices.length&&(i.restore.call(this),this._matrix=this._savedMatrices.pop(),this._setMatrix())},scale(t,s){this._matrix=this._matrix.scaleNonUniform(t,s),i.scale.call(this,t,s)},getTransform(){return this._matrix},rotate(t){this._matrix=this._matrix.rotate(180*t/Math.PI),i.rotate.call(this,t)},translate(t,s){this._matrix=this._matrix.translate(t,s),i.translate.call(this,t,s)},transform(t,s,e,r,n,h){const o=A();o.a=t,o.b=s,o.c=e,o.d=r,o.e=n,o.f=h,this._matrix=this._matrix.multiply(o),i.transform.call(this,t,s,e,r,n,h)},resetTransform(){this._matrix=A(),i.resetTransform.call(this)},__proto__:i},t}}]);